<Page
    x:Class="RyTuneX.Views.GroupPolicyPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:local="using:RyTuneX.Views"
    mc:Ignorable="d">
    <Page.Resources>
        <x:Double x:Key="SettingsCardSpacing">4</x:Double>
        <Style x:Key="SettingsSectionHeaderTextBlockStyle"
               BasedOn="{StaticResource BodyStrongTextBlockStyle}"
               TargetType="TextBlock">
            <Style.Setters>
                <Setter Property="Margin" Value="1,30,0,6" />
            </Style.Setters>
        </Style>
    </Page.Resources>
    <Grid x:Name="ContentArea">
        <ScrollViewer Padding="24,14,24,0">
            <StackPanel Margin="0,0,0,38" Spacing="{StaticResource SettingsCardSpacing}">
                <StackPanel.ChildrenTransitions>
                    <EntranceThemeTransition FromVerticalOffset="50" />
                    <RepositionThemeTransition IsStaggeringEnabled="False" />
                </StackPanel.ChildrenTransitions>
                <InfoBar x:Name="InfoBanner"
                         x:Uid="GroupPolicyPage_InfoBanner"
                         IsOpen="True"
                         IsClosable="False"
                         Severity="Informational"
                         Margin="0,0,0,16"/>
                
                <controls:SettingsExpander x:Name="PolicySummaryExpander"
                                           x:Uid="GroupPolicyPage_PolicySummaryExpander"
                                           IsExpanded="True">
                    <controls:SettingsExpander.HeaderIcon>
                        <FontIcon Glyph="&#xE9D5;"/>
                    </controls:SettingsExpander.HeaderIcon>
                    <controls:SettingsExpander.Items>
                        <controls:SettingsCard>
                            <controls:SettingsCard.Header>
                                <StackPanel Orientation="Horizontal" Spacing="12">
                                    <ProgressRing x:Name="ScanProgressRing" 
                                                  IsActive="True" 
                                                  Width="20" 
                                                  Height="20"
                                                  Visibility="Visible"/>
                                    <TextBlock x:Name="SummaryText" 
                                               x:Uid="GroupPolicyPage_ScanningText"
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                            </controls:SettingsCard.Header>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Button x:Name="RefreshButton"
                                        Click="RefreshButton_Click">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon Glyph="&#xE72C;" FontSize="14"/>
                                        <TextBlock x:Uid="GroupPolicyPage_RefreshText"/>
                                    </StackPanel>
                                </Button>
                                <Button x:Name="RemoveAllButton"
                                        Click="RemoveAllButton_Click"
                                        IsEnabled="False"
                                        Style="{StaticResource AccentButtonStyle}">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon Glyph="&#xE74D;" FontSize="14"/>
                                        <TextBlock x:Uid="GroupPolicyPage_RemoveAllText"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </controls:SettingsCard>
                    </controls:SettingsExpander.Items>
                </controls:SettingsExpander>

                <TextBlock x:Uid="GroupPolicyPage_CategoriesHeader"
                           Style="{StaticResource SettingsSectionHeaderTextBlockStyle}"
                           Margin="6"/>
                
                <ItemsRepeater x:Name="CategorySummaryRepeater">
                    <ItemsRepeater.Layout>
                        <StackLayout Spacing="4"/>
                    </ItemsRepeater.Layout>
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate x:DataType="local:CategorySummaryItem">
                            <controls:SettingsCard>
                                <controls:SettingsCard.Header>
                                    <TextBlock Text="{x:Bind Category}" FontWeight="SemiBold"/>
                                </controls:SettingsCard.Header>
                                <controls:SettingsCard.Description>
                                    <TextBlock Text="{x:Bind StatusText}" 
                                               Foreground="{x:Bind StatusColor}"/>
                                </controls:SettingsCard.Description>
                                <controls:SettingsCard.HeaderIcon>
                                    <FontIcon Glyph="{x:Bind IconGlyph}"/>
                                </controls:SettingsCard.HeaderIcon>
                                <Button Content="{x:Bind ButtonText}"
                                        Tag="{x:Bind Category}"
                                        Click="CategoryRemoveButton_Click"
                                        IsEnabled="{x:Bind HasConfiguredPolicies}"/>
                            </controls:SettingsCard>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>

                <TextBlock x:Uid="GroupPolicyPage_ConfiguredPoliciesHeader"
                           Style="{StaticResource SettingsSectionHeaderTextBlockStyle}"
                           Margin="6"/>

                <controls:SettingsExpander x:Name="ConfiguredPoliciesExpander"
                                           x:Uid="GroupPolicyPage_DetailedPolicyListExpander"
                                           IsExpanded="False">
                    <controls:SettingsExpander.HeaderIcon>
                        <FontIcon Glyph="&#xE90F;"/>
                    </controls:SettingsExpander.HeaderIcon>
                    <controls:SettingsExpander.Items>
                        <controls:SettingsCard>
                            <controls:SettingsCard.Header>
                                <StackPanel>
                                    <ListView x:Name="ConfiguredPoliciesListView"
                                              SelectionMode="Multiple"
                                              MaxHeight="400">
                                        <ListView.ItemTemplate>
                                            <DataTemplate x:DataType="local:PolicyStateViewModel">
                                                <Grid Padding="8,4" ColumnSpacing="12">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                                        <TextBlock Text="{x:Bind Policy.Name}" 
                                                                   FontWeight="SemiBold"
                                                                   TextTrimming="CharacterEllipsis"/>
                                                        <TextBlock Text="{x:Bind Policy.Description}" 
                                                                   Style="{StaticResource CaptionTextBlockStyle}"
                                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                                   TextTrimming="CharacterEllipsis"/>
                                                        <TextBlock Text="{x:Bind Policy.Category}"
                                                                   Style="{StaticResource CaptionTextBlockStyle}"
                                                                   Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                                                    </StackPanel>
                                                    <TextBlock Grid.Column="1" 
                                                               Text="{x:Bind HiveDisplay}"
                                                               Style="{StaticResource CaptionTextBlockStyle}"
                                                               VerticalAlignment="Center"
                                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                                    <Button Grid.Column="2"
                                                            Tag="{x:Bind Policy.Id}"
                                                            Click="PolicyRemoveButton_Click"
                                                            VerticalAlignment="Center">
                                                        <FontIcon Glyph="&#xE74D;" FontSize="12"/>
                                                    </Button>
                                                </Grid>
                                            </DataTemplate>
                                        </ListView.ItemTemplate>
                                    </ListView>
                                    <StackPanel x:Name="NoPoliciesPanel" 
                                                Visibility="Collapsed"
                                                HorizontalAlignment="Center"
                                                Padding="24">
                                        <FontIcon Glyph="&#xE73E;" 
                                                  FontSize="48" 
                                                  Foreground="{ThemeResource SystemFillColorSuccessBrush}"/>
                                        <TextBlock x:Uid="GroupPolicyPage_NoPoliciesText"
                                                   HorizontalAlignment="Center"
                                                   Margin="0,12,0,0"/>
                                    </StackPanel>
                                </StackPanel>
                            </controls:SettingsCard.Header>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Button x:Name="RemoveSelectedButton"
                                        Click="RemoveSelectedButton_Click"
                                        IsEnabled="False">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon Glyph="&#xE74D;" FontSize="14"/>
                                        <TextBlock x:Uid="GroupPolicyPage_RemoveSelectedText"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </controls:SettingsCard>
                    </controls:SettingsExpander.Items>
                </controls:SettingsExpander>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>
